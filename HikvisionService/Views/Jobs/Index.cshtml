@model IEnumerable<HikvisionService.Models.FileDownloadJob>
@{
    ViewData["Title"] = "Download Jobs";
}

<div class="container-fluid">
    <h1 class="mt-4">Download Jobs</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="jobTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="active-tab" data-toggle="tab" href="#active" role="tab" aria-controls="active" aria-selected="true">
                        Active Downloads
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="failed-tab" data-toggle="tab" href="#failed" role="tab" aria-controls="failed" aria-selected="false">
                        Failed Downloads
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="completed-tab" data-toggle="tab" href="#completed" role="tab" aria-controls="completed" aria-selected="false">
                        Completed Downloads
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="jobTabsContent">
                <!-- Active Downloads Tab -->
                <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
                    <div id="activeDownloads">
                        <p class="text-center">Loading active downloads...</p>
                    </div>
                </div>
                
                <!-- Failed Downloads Tab -->
                <div class="tab-pane fade" id="failed" role="tabpanel" aria-labelledby="failed-tab">
                    <div id="failedDownloads">
                        <p class="text-center">Loading failed downloads...</p>
                    </div>
                </div>
                
                <!-- Completed Downloads Tab -->
                <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
                    <div id="completedDownloads">
                        <p class="text-center">Loading completed downloads...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load active downloads
            function loadActiveDownloads() {
                $.ajax({
                    url: '/api/download-jobs/active',
                    type: 'GET',
                    success: function(jobs) {
                        if (jobs.length === 0) {
                            $('#activeDownloads').html('<p class="text-center">No active downloads.</p>');
                            return;
                        }
                        
                        let html = '<div class="table-responsive">';
                        html += '<table class="table table-bordered" width="100%" cellspacing="0">';
                        html += '<thead><tr><th>Camera</th><th>File</th><th>Progress</th><th>Started</th><th>Action</th></tr></thead>';
                        html += '<tbody>';
                        
                        jobs.forEach(function(job) {
                            html += '<tr>';
                            html += `<td>${job.camera.name}</td>`;
                            html += `<td>${job.fileName}</td>`;
                            html += '<td>';
                            html += `<div class="progress">`;
                            html += `<div class="progress-bar" role="progressbar" style="width: ${job.progress}%" `;
                            html += `aria-valuenow="${job.progress}" aria-valuemin="0" aria-valuemax="100">${job.progress}%</div>`;
                            html += '</div>';
                            html += '</td>';
                            html += `<td>${new Date(job.startTime).toLocaleString()}</td>`;
                            html += `<td><button class="btn btn-sm btn-danger cancel-job" data-id="${job.id}">Cancel</button></td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></div>';
                        $('#activeDownloads').html(html);
                        
                        // Attach event handlers to cancel buttons
                        $('.cancel-job').click(function() {
                            const jobId = $(this).data('id');
                            cancelJob(jobId);
                        });
                    },
                    error: function() {
                        $('#activeDownloads').html('<p class="text-center text-danger">Failed to load active downloads.</p>');
                    }
                });
            }
            
            // Load failed downloads
            function loadFailedDownloads() {
                $.ajax({
                    url: '/api/download-jobs/failed',
                    type: 'GET',
                    success: function(jobs) {
                        if (jobs.length === 0) {
                            $('#failedDownloads').html('<p class="text-center">No failed downloads.</p>');
                            return;
                        }
                        
                        let html = '<div class="table-responsive">';
                        html += '<table class="table table-bordered" width="100%" cellspacing="0">';
                        html += '<thead><tr><th>Camera</th><th>File</th><th>Error</th><th>Failed At</th><th>Action</th></tr></thead>';
                        html += '<tbody>';
                        
                        jobs.forEach(function(job) {
                            html += '<tr>';
                            html += `<td>${job.camera.name}</td>`;
                            html += `<td>${job.fileName}</td>`;
                            html += `<td>${job.errorMessage || 'Unknown error'}</td>`;
                            html += `<td>${new Date(job.updatedAt).toLocaleString()}</td>`;
                            html += `<td><button class="btn btn-sm btn-primary retry-job" data-id="${job.id}">Retry</button></td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></div>';
                        $('#failedDownloads').html(html);
                        
                        // Attach event handlers to retry buttons
                        $('.retry-job').click(function() {
                            const jobId = $(this).data('id');
                            retryJob(jobId);
                        });
                    },
                    error: function() {
                        $('#failedDownloads').html('<p class="text-center text-danger">Failed to load failed downloads.</p>');
                    }
                });
            }
            
            // Load completed downloads
            function loadCompletedDownloads() {
                $.ajax({
                    url: '/api/download-jobs',
                    type: 'GET',
                    success: function(allJobs) {
                        // Filter completed jobs
                        const jobs = allJobs.filter(job => job.status === 'completed');
                        
                        if (jobs.length === 0) {
                            $('#completedDownloads').html('<p class="text-center">No completed downloads.</p>');
                            return;
                        }
                        
                        let html = '<div class="table-responsive">';
                        html += '<table class="table table-bordered" id="completedJobsTable" width="100%" cellspacing="0">';
                        html += '<thead><tr><th>Camera</th><th>File</th><th>Size</th><th>Started</th><th>Completed</th></tr></thead>';
                        html += '<tbody>';
                        
                        jobs.forEach(function(job) {
                            html += '<tr>';
                            html += `<td>${job.camera.name}</td>`;
                            html += `<td>${job.fileName}</td>`;
                            html += `<td>${formatBytes(job.fileSize)}</td>`;
                            html += `<td>${job.startTime ? new Date(job.startTime).toLocaleString() : 'N/A'}</td>`;
                            html += `<td>${job.endTime ? new Date(job.endTime).toLocaleString() : 'N/A'}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></div>';
                        $('#completedDownloads').html(html);
                        
                        // Initialize DataTable for completed jobs
                        $('#completedJobsTable').DataTable({
                            "order": [[4, "desc"]], // Sort by completion time
                            "pageLength": 10
                        });
                    },
                    error: function() {
                        $('#completedDownloads').html('<p class="text-center text-danger">Failed to load completed downloads.</p>');
                    }
                });
            }
            
            function cancelJob(jobId) {
                $.ajax({
                    url: `/api/download-jobs/${jobId}/cancel`,
                    type: 'POST',
                    success: function() {
                        toastr.success('Download job cancelled.');
                        loadActiveDownloads();
                    },
                    error: function() {
                        toastr.error('Failed to cancel download job.');
                    }
                });
            }
            
            function retryJob(jobId) {
                $.ajax({
                    url: `/api/download-jobs/${jobId}/retry`,
                    type: 'POST',
                    success: function() {
                        toastr.success('Download job retry initiated.');
                        loadFailedDownloads();
                        setTimeout(loadActiveDownloads, 1000);
                    },
                    error: function() {
                        toastr.error('Failed to retry download job.');
                    }
                });
            }
            
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
            
            // Load initial data
            loadActiveDownloads();
            
            // Load data for other tabs when they're clicked
            $('#jobTabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                const target = $(e.target).attr("href");
                
                if (target === '#active') {
                    loadActiveDownloads();
                } else if (target === '#failed') {
                    loadFailedDownloads();
                } else if (target === '#completed') {
                    loadCompletedDownloads();
                }
            });
            
            // Refresh active downloads every 5 seconds
            setInterval(function() {
                if ($('#active-tab').hasClass('active')) {
                    loadActiveDownloads();
                }
            }, 5000);
        });
    </script>
}
@model HikvisionService.Models.ViewModels.JobsIndexViewModel
@{
    ViewData["Title"] = "Download Jobs";
}

<div class="px-6 py-4">
    <h1 class="text-3xl font-bold mb-6">Download Jobs</h1>

    <div class="bg-white shadow rounded-lg">
        <!-- Filters Section -->
        <div class="border-b border-gray-200 px-6 py-4">
            <form method="get" action="@Url.Action("Index")" id="filterForm">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Store Filter -->
                    <div>
                        <label for="storeId" class="block text-sm font-medium text-gray-700 mb-1">Store</label>
                        <select name="storeId" id="storeId" class="form-select w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            @foreach (var store in Model.Stores)
                            {
                                <option value="@store.Value" selected="@(store.Value == Model.StoreId?.ToString())">@store.Text</option>
                            }
                        </select>
                    </div>

                    <!-- Camera Filter -->
                    <div>
                        <label for="cameraId" class="block text-sm font-medium text-gray-700 mb-1">Camera</label>
                        <select name="cameraId" id="cameraId" class="form-select w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            @foreach (var camera in Model.Cameras)
                            {
                                <option value="@camera.Value" selected="@(camera.Value == Model.CameraId?.ToString())">@camera.Text</option>
                            }
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" id="status" class="form-select w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            @foreach (var statusOption in Model.StatusOptions)
                            {
                                <option value="@statusOption.Value" selected="@(statusOption.Value == Model.Status)">@statusOption.Text</option>
                            }
                        </select>
                    </div>

                    <!-- Filter Actions -->
                    <div class="flex items-end space-x-2">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search mr-1"></i> Filter
                        </button>
                        <a href="@Url.Action("Index")" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            <i class="fas fa-times mr-1"></i> Clear
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Results Summary -->
        <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-600">
                    Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) to @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalJobs)) of @Model.TotalJobs jobs
                </p>
                @if (Model.TotalPages > 1)
                {
                    <p class="text-sm text-gray-600">
                        Page @Model.CurrentPage of @Model.TotalPages
                    </p>
                }
            </div>
        </div>

        <!-- Jobs Table -->
        <div class="overflow-x-auto">
            @if (Model.Jobs.Any())
            {
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Camera</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Store</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Period</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Error</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @foreach (var job in Model.Jobs)
                        {
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">@job.Camera.Name</div>
                                        <div class="text-sm text-gray-500">@job.Camera.IpAddress:@job.Camera.Port</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    @(job.Camera.Store?.Name ?? "No Store")
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        <div><strong>Start:</strong> @job.FileStartTime.ToString("yyyy-MM-dd HH:mm")</div>
                                        <div><strong>End:</strong> @job.FileEndTime.ToString("yyyy-MM-dd HH:mm")</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        @if (job.StartTime.HasValue)
                                        {
                                            <div><strong>Started:</strong> @job.StartTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</div>
                                        }
                                        @if (job.EndTime.HasValue)
                                        {
                                            <div><strong>Ended:</strong> @job.EndTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</div>
                                        }
                                        <div class="text-xs text-gray-500">Updated: @job.UpdatedAt.ToString("yyyy-MM-dd HH:mm:ss")</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    @if (job.FileSize > 0)
                                    {
                                        @($"{(job.FileSize / 1024.0 / 1024.0):F1} MB")
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">-</span>
                                    }
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    @{
                                        var statusClass = job.Status switch
                                        {
                                            "pending" => "bg-yellow-100 text-yellow-800",
                                            "downloading" => "bg-blue-100 text-blue-800",
                                            "completed" => "bg-green-100 text-green-800",
                                            "failed" => "bg-red-100 text-red-800",
                                            _ => "bg-gray-100 text-gray-800"
                                        };
                                    }
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full @statusClass">
                                        @job.Status.ToUpper()
                                    </span>
                                    @if (job.Status == "downloading" && job.Progress > 0)
                                    {
                                        <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: @(job.Progress)%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">@job.Progress%</div>
                                    }
                                </td>
                                <td class="px-6 py-4 text-wrap">
                                    @if (!string.IsNullOrEmpty(job.ErrorMessage))
                                    {
                                        <span class="text-sm text-red-600">@job.ErrorMessage</span>
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">-</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="px-6 py-12 text-center">
                    <div class="text-gray-400">
                        <i class="fas fa-inbox fa-3x mb-4"></i>
                        <p class="text-lg">No jobs found</p>
                        <p class="text-sm">Try adjusting your filters to see more results.</p>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div class="flex-1 flex justify-between sm:hidden">
                    @if (Model.HasPreviousPage)
                    {
                        <a href="@GetPageUrl(Model.CurrentPage - 1)" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Previous
                        </a>
                    }
                    @if (Model.HasNextPage)
                    {
                        <a href="@GetPageUrl(Model.CurrentPage + 1)" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Next
                        </a>
                    }
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing page <span class="font-medium">@Model.CurrentPage</span> of <span class="font-medium">@Model.TotalPages</span>
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            @if (Model.HasPreviousPage)
                            {
                                <a href="@GetPageUrl(1)" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                                <a href="@GetPageUrl(Model.CurrentPage - 1)" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            }

                            @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                            {
                                @if (i == Model.CurrentPage)
                                {
                                    <span class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-medium text-blue-600">
                                        @i
                                    </span>
                                }
                                else
                                {
                                    <a href="@GetPageUrl(i)" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                        @i
                                    </a>
                                }
                            }

                            @if (Model.HasNextPage)
                            {
                                <a href="@GetPageUrl(Model.CurrentPage + 1)" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                                <a href="@GetPageUrl(Model.TotalPages)" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            }
                        </nav>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@functions {
    public string GetPageUrl(int page)
    {
        var routeValues = new Dictionary<string, object?> { { "page", page } };
        
        if (Model.StoreId.HasValue)
            routeValues["storeId"] = Model.StoreId;
        if (Model.CameraId.HasValue)
            routeValues["cameraId"] = Model.CameraId;
        if (!string.IsNullOrEmpty(Model.Status))
            routeValues["status"] = Model.Status;

        return Url.Action("Index", routeValues)!;
    }
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize Select2 for dropdowns
            $('#storeId, #cameraId, #status').select2({
                theme: 'default',
                width: '100%'
            });

            // Store selection auto-filters cameras
            $('#storeId').on('change', function() {
                var storeId = $(this).val();
                var cameraSelect = $('#cameraId');
                
                if (storeId === '') {
                    // Show all cameras
                    loadAllCameras();
                } else {
                    // Filter cameras by store
                    $.get('/Jobs/GetCamerasByStore', { storeId: storeId })
                        .done(function(cameras) {
                            cameraSelect.empty();
                            cameraSelect.append('<option value="">All Cameras</option>');
                            
                            $.each(cameras, function(index, camera) {
                                cameraSelect.append('<option value="' + camera.id + '">' + camera.name + '</option>');
                            });
                            
                            cameraSelect.trigger('change.select2');
                        })
                        .fail(function() {
                            toastr.error('Failed to load cameras for the selected store');
                        });
                }
            });

            function loadAllCameras() {
                var cameraSelect = $('#cameraId');
                
                $.get('/Jobs/GetCamerasByStore')
                    .done(function(cameras) {
                        var currentValue = cameraSelect.val();
                        cameraSelect.empty();
                        cameraSelect.append('<option value="">All Cameras</option>');
                        
                        $.each(cameras, function(index, camera) {
                            cameraSelect.append('<option value="' + camera.id + '">' + camera.name + '</option>');
                        });
                        
                        if (currentValue) {
                            cameraSelect.val(currentValue);
                        }
                        cameraSelect.trigger('change.select2');
                    });
            }

            // Auto-refresh every 30 seconds if on downloading status
            @if (Model.Status == "downloading" || string.IsNullOrEmpty(Model.Status))
            {
                <text>
                setInterval(function() {
                    if ($('#status').val() === 'downloading' || $('#status').val() === '') {
                        // Only refresh if we're looking at downloading or all statuses
                        var currentUrl = window.location.href;
                        
                        // Use AJAX to check if there are any status updates
                        $.get(currentUrl + '&ajax=1')
                            .done(function(data) {
                                // Simple check - if the response has changed significantly, reload
                                var parser = new DOMParser();
                                var doc = parser.parseFromString(data, 'text/html');
                                var newTableContent = $(doc).find('tbody').html();
                                var currentTableContent = $('tbody').html();
                                
                                if (newTableContent !== currentTableContent) {
                                    location.reload();
                                }
                            });
                    }
                }, 30000); // 30 seconds
                </text>
            }
        });
    </script>
}

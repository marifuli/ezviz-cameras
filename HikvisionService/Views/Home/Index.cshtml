@model HikvisionService.Models.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="p-6 space-y-2 bg-gray-50 min-h-screen">

    <!-- PAGE TITLE -->
    <h1 class="text-2xl font-semibold text-gray-800">
        Dashboard
    </h1>

    <!-- ===================== -->
    <!-- SUMMARY STAT CARDS -->
    <!-- ===================== -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-7 gap-4">

        <!-- Total Cameras -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Total Cameras</p>
                <p class="text-2xl font-bold text-gray-800">@Model.TotalCameras</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                <i class="fas fa-camera"></i>
            </div>
        </div>

        <!-- Online -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Online</p>
                <p class="text-2xl font-bold text-gray-800">@Model.OnlineCameras</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>

        <!-- Offline -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Offline</p>
                <p class="text-2xl font-bold text-gray-800">@Model.OfflineCameras</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-red-100 text-red-600 flex items-center justify-center">
                <i class="fas fa-times-circle"></i>
            </div>
        </div>

        <!-- Active Workers -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Active Workers</p>
                <p class="text-2xl font-bold text-gray-800">@Model.ActiveWorkers</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center">
                <i class="fas fa-tasks"></i>
            </div>
        </div>

        <!-- Active Downloads -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Active Downloads</p>
                <p class="text-2xl font-bold text-gray-800">@Model.ActiveDownloadJobs</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-cyan-100 text-cyan-600 flex items-center justify-center">
                <i class="fas fa-download"></i>
            </div>
        </div>

        <!-- Failed Downloads -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex justify-between items-center">
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Failed</p>
                <p class="text-2xl font-bold text-gray-800">@Model.FailedDownloadJobs</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-xl shadow-sm p-4">
            <p class="text-xs uppercase tracking-wide text-gray-500 mb-2">Actions</p>
            <button id="checkAllCameras"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">
                <i class="fas fa-sync"></i> Check All
            </button>
        </div>

    </div>

    <!-- ===================== -->
    <!-- WORKER STATUS TABLE -->
    <!-- ===================== -->
    <div class="bg-white rounded-xl shadow-sm">
        <div class="px-5 py-4 border-b flex justify-between items-center">
            <h2 class="font-semibold text-gray-800">Camera Workers Status</h2>
            <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-600">
                @Model.ActiveWorkers / @Model.TotalCameras Workers
            </span>
        </div>
        <div class="p-4 overflow-x-auto" style="overflow: auto; height: 300px;">
            <table class="w-full text-sm">
                <thead class="text-gray-500 border-b">
                    <tr>
                        <th class="py-2 text-left">ID</th>
                        <th class="py-2 text-left">Camera Name</th>
                        <th class="py-2 text-left">IP Address</th>
                        <th class="py-2 text-left">Status</th>
                        <th class="py-2 text-left">Worker State</th>
                        <th class="py-2 text-left">Active Downloads</th>
                        <th class="py-2 text-left">Last Error</th>
                        <th class="py-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    @foreach (var camera in Model.Cameras)
                    {
                        var worker = Model.WorkerStatus.FirstOrDefault(w => w.CameraId == camera.Id);
                        <tr class="hover:bg-gray-50">
                            <td class="py-2">@camera.Id</td>
                            <td class="py-2 font-medium">@camera.Name</td>
                            <td class="py-2">@camera.IpAddress</td>
                            <td class="py-2">
                                @if (camera.IsOnline)
                                {
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-600">
                                        <i class="fas fa-circle text-xs mr-1"></i> Online
                                    </span>
                                }
                                else
                                {
                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-600">
                                        <i class="fas fa-circle text-xs mr-1"></i> Offline
                                    </span>
                                }
                            </td>
                            <td class="py-2">
                                @if (worker != null)
                                {
                                    if (worker.IsRunning)
                                    {
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-600">
                                            <i class="fas fa-play mr-1"></i> Running
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                            <i class="fas fa-stop mr-1"></i> Stopped
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                        <i class="fas fa-hourglass mr-1"></i> Not Started
                                    </span>
                                }
                            </td>
                            <td class="py-2">
                                @if (worker != null && worker.ActiveDownloadCount > 0)
                                {
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-600">
                                        @worker.ActiveDownloadCount Active
                                    </span>
                                }
                                else
                                {
                                    <span class="text-gray-400">0</span>
                                }
                            </td>
                            <td class="py-2 max-w-xs truncate">
                                @if (!string.IsNullOrEmpty(camera.LastError))
                                {
                                    <span class="text-red-600 text-xs" title="@camera.LastError">
                                        <i class="fas fa-exclamation-circle mr-1"></i> @(camera.LastError.Length > 30 ? camera.LastError.Substring(0, 30) + "..." : camera.LastError)
                                    </span>
                                }
                                else
                                {
                                    <span class="text-gray-400">-</span>
                                }
                            </td>
                            <td class="py-2">
                                <div class="flex gap-1">
                                    <button data-id="@camera.Id"
                                            class="check-camera px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded"
                                            title="Check Camera">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    <button data-id="@camera.Id"
                                            class="restart-worker px-2 py-1 text-xs bg-purple-600 hover:bg-purple-700 text-white rounded"
                                            title="Restart Worker">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- ===================== -->
    <!-- OFFLINE + STORAGE -->
    <!-- ===================== -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

        <!-- OFFLINE CAMERAS -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="px-5 py-4 border-b flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">Offline Cameras</h2>
                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-600">
                    @Model.OfflineCameras
                </span>
            </div>

            <div class="p-4">
                @if (Model.OfflineCamerasList.Any())
                {
                    <table class="w-full text-sm">
                        <thead class="text-gray-500 border-b">
                            <tr>
                                <th class="py-2 text-left">Camera</th>
                                <th class="py-2 text-left">Last Online</th>
                                <th class="py-2 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            @foreach (var camera in Model.OfflineCamerasList)
                            {
                                <tr>
                                    <td class="py-2">@camera.Name</td>
                                    <td class="py-2">
                                        @(camera.LastOnlineAt?.ToString("yyyy-MM-dd HH:mm") ?? "Never")
                                    </td>
                                    <td class="py-2 text-right">
                                        <button data-id="@camera.Id"
                                                class="check-camera px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-center text-green-600">All cameras are online ðŸŽ‰</p>
                }
            </div>
        </div>

        <!-- STORAGE -->
        <div class="xl:col-span-2 bg-white rounded-xl shadow-sm">
            <div class="px-5 py-4 border-b flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">Storage Usage</h2>
                <button id="checkStorage"
                        class="px-3 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    <i class="fas fa-sync"></i> Check
                </button>
            </div>

            <div class="p-4 space-y-4">
                @foreach (var drive in Model.StorageDrives)
                {
                    <div class="border rounded-lg p-3">
                        <div class="flex justify-between text-sm font-medium mb-2">
                            <span>@drive.Name (@drive.RootPath)</span>
                            <span>@drive.UsagePercentage.ToString("F1")%</span>
                        </div>

                        <div class="w-full h-2 bg-gray-200 rounded">
                            <div class="h-2 rounded bg-blue-600"
                                 style="width:@drive.UsagePercentage%"></div>
                        </div>

                        <div class="mt-2 text-xs text-gray-500 flex justify-between">
                            <span>Used: @FormatBytes(drive.UsedSpace)</span>
                            <span>Free: @FormatBytes(drive.FreeSpace)</span>
                            <span>Total: @FormatBytes(drive.TotalSpace)</span>
                        </div>
                    </div>
                }
            </div>
        </div>

    </div>

    <!-- ===================== -->
    <!-- ACTIVE DOWNLOADS -->
    <!-- ===================== -->
    <div class="bg-white rounded-xl shadow-sm">
        <div class="px-5 py-4 border-b">
            <h2 class="font-semibold text-gray-800">Active Downloads</h2>
        </div>
        <div class="p-4" id="activeDownloads" style="overflow: auto; height: 250px;">
            <p class="text-center text-gray-500">Loading active downloads...</p>
        </div>
    </div>

    <!-- ===================== -->
    <!-- CHARTS -->
    <!-- ===================== -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm p-4">
            <h3 class="font-semibold mb-2">Downloads Per Day</h3>
            <div class="h-72">
                <canvas id="downloadsPerDayChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4">
            <h3 class="font-semibold mb-2">Downloads Per Camera</h3>
            <div class="h-72">
                <canvas id="downloadsPerCameraChart"></canvas>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <script>
        window.workerStatus = @Html.Raw(Json.Serialize(Model.WorkerStatus));
        
        // Now you can use it in JavaScript
        console.log(window.workerStatus);
        
        // Example: Loop through workers
        window.workerStatus.forEach(function(worker) {
            console.log(`Camera ${worker.cameraId}: ${worker.cameraName} - ${worker.isRunning ? 'Running' : 'Stopped'}`);
        });
        $(document).ready(function() {
            // Check camera connection
            $('.check-camera').click(function() {
                const cameraId = $(this).data('id');
                const button = $(this);
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: `/api/cameras/${cameraId}/check`,
                    type: 'POST',
                    success: function(result) {
                        if (result.isOnline) {
                            toastr.success('Camera is online!');
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            toastr.error('Camera is offline.');
                            button.prop('disabled', false);
                            button.html('<i class="fas fa-sync"></i>');
                        }
                    },
                    error: function() {
                        toastr.error('Failed to check camera connection.');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync"></i>');
                    }
                });
            });
            
            // Restart worker
            $('.restart-worker').click(function() {
                const cameraId = $(this).data('id');
                const button = $(this);
                
                if (!confirm('Restart worker for this camera? Active downloads will be paused.')) {
                    return;
                }
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: `/api/workers/${cameraId}/restart`,
                    type: 'POST',
                    success: function() {
                        toastr.success('Worker restart triggered');
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    },
                    error: function() {
                        toastr.error('Failed to restart worker');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-redo"></i>');
                    }
                });
            });
            
            // Check all cameras
            $('#checkAllCameras').click(function() {
                const button = $(this);
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i> Checking...');
                
                $.ajax({
                    url: '/api/cameras/check-all',
                    type: 'POST',
                    success: function() {
                        toastr.success('Camera health check triggered.');
                        setTimeout(function() {
                            location.reload();
                        }, 3000);
                    },
                    error: function() {
                        toastr.error('Failed to trigger camera health check.');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync"></i> Check All');
                    }
                });
            });
            
            // Check storage
            $('#checkStorage').click(function() {
                const button = $(this);
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i> Checking...');
                
                $.ajax({
                    url: '/api/storage-drives/check',
                    type: 'POST',
                    success: function() {
                        toastr.success('Storage check triggered.');
                        setTimeout(function() {
                            location.reload();
                        }, 3000);
                    },
                    error: function() {
                        toastr.error('Failed to trigger storage check.');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync"></i> Check Storage');
                    }
                });
            });
            
            // Load active downloads
            function loadActiveDownloads() {
                $.ajax({
                    url: '/api/download-jobs/active',
                    type: 'GET',
                    success: function(jobs) {
                        if (jobs.length === 0) {
                            $('#activeDownloads').html('<p class="text-center">No active downloads.</p>');
                            return;
                        }
                        let html = '<div class="overflow-x-auto">';
                        html += '<table class="min-w-full divide-y divide-gray-200 border border-gray-200 text-sm">';
                        html += '<thead class="bg-gray-100">';
                        html += '<tr>';
                        html += '<th class="px-4 py-2 text-left font-semibold text-gray-700">Camera</th>';
                        html += '<th class="px-4 py-2 text-left font-semibold text-gray-700">File</th>';
                        html += '<th class="px-4 py-2 text-left font-semibold text-gray-700">Progress</th>';
                        html += '<th class="px-4 py-2 text-left font-semibold text-gray-700">Started</th>';
                        html += '</tr>';
                        html += '</thead>';
                        html += '<tbody class="bg-white divide-y divide-gray-200">';

                        jobs.forEach(function(job) {
                            html += '<tr class="hover:bg-gray-50">';
                            html += `<td class="px-4 py-2">${job.cameraName}</td>`;
                            html += `<td class="px-4 py-2">${job.fileName}</td>`;
                            
                            html += '<td class="px-4 py-2">';
                            html += '<div class="w-full bg-gray-200 rounded-full h-4">';
                            html += `<div class="bg-blue-600 h-4 rounded-full text-xs text-white flex items-center justify-center transition-all duration-300" 
                                    style="width: ${job.progress}%">`;
                            html += `${job.progress}%`;
                            html += '</div>';
                            html += '</div>';
                            html += '</td>';
                            
                            html += `<td class="px-4 py-2">${new Date(job.startTime).toLocaleString()}</td>`;
                            html += '</tr>';
                        });

                        html += '</tbody></table></div>';
                        $('#activeDownloads').html(html);
                    },
                    error: function() {
                        $('#activeDownloads').html('<p class="text-center text-danger">Failed to load active downloads.</p>');
                    }
                });
            }
            
            // Initial load
            loadActiveDownloads();
            
            // Refresh active downloads every 5 seconds
            setInterval(loadActiveDownloads, 15000);
            
            // Initialize charts
            initializeCharts();
        });
        
        function initializeCharts() {
            // Downloads Per Day Chart
            const downloadsPerDayCtx = document.getElementById('downloadsPerDayChart').getContext('2d');
            
            // Parse data from model
            const downloadsPerDayData = @Html.Raw(Json.Serialize(Model.DownloadsPerDay));
            
            // Sort data by date
            downloadsPerDayData.sort((a, b) => new Date(a.label) - new Date(b.label));
            
            // Format dates for display
            const labels = downloadsPerDayData.map(item => {
                const date = new Date(item.label);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const values = downloadsPerDayData.map(item => item.value);
            
            new Chart(downloadsPerDayCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Downloads',
                        data: values,
                        backgroundColor: 'rgba(78, 115, 223, 0.8)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Downloads Per Camera Chart
            const downloadsPerCameraCtx = document.getElementById('downloadsPerCameraChart').getContext('2d');
            
            // Parse data from model
            const downloadsPerCameraData = @Html.Raw(Json.Serialize(Model.DownloadsPerCamera));
            
            // Convert dictionary to arrays
            const cameraLabels = Object.keys(downloadsPerCameraData);
            const cameraValues = Object.values(downloadsPerCameraData);
            
            // Generate colors
            const backgroundColors = cameraLabels.map((_, i) => {
                const hue = (i * 137) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            
            new Chart(downloadsPerCameraCtx, {
                type: 'doughnut',
                data: {
                    labels: cameraLabels,
                    datasets: [{
                        data: cameraValues,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12
                            }
                        }
                    }
                }
            });
        }
    </script>
}

@functions {
    public string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size = size / 1024;
        }
        
        return $"{size:0.##} {sizes[order]}";
    }
}
@model HikvisionService.Models.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">
    <h1 class="mt-4">Camera Monitoring Dashboard</h1>
    
    <!-- System Summary Cards -->
    <div class="row mt-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Cameras</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalCameras</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-camera fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Online Cameras</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.OnlineCameras</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Offline Cameras</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.OfflineCameras</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Active Downloads</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.ActiveDownloadJobs</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-download fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Failed Downloads</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.FailedDownloadJobs</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Actions</div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-primary" id="checkAllCameras">
                                    <i class="fas fa-sync"></i> Check All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Offline Cameras List -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Offline Cameras</h6>
                </div>
                <div class="card-body">
                    @if (Model.OfflineCamerasList.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Camera</th>
                                        <th>Last Online</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var camera in Model.OfflineCamerasList)
                                    {
                                        <tr>
                                            <td>@camera.Name</td>
                                            <td>
                                                @if (camera.LastOnlineAt.HasValue)
                                                {
                                                    <span title="@camera.LastOnlineAt">
                                                        @camera.LastOnlineAt.Value.ToString("yyyy-MM-dd HH:mm")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span>Never</span>
                                                }
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-primary check-camera" data-id="@camera.Id">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center">
                            <p class="text-success">All cameras are online!</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Storage Usage Panel -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Storage Usage</h6>
                    <div class="dropdown no-arrow">
                        <button class="btn btn-sm btn-primary" id="checkStorage">
                            <i class="fas fa-sync"></i> Check Storage
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.StorageDrives.Any())
                    {
                        foreach (var drive in Model.StorageDrives)
                        {
                            <div class="mb-4">
                                <h4 class="small font-weight-bold">
                                    @drive.Name (@drive.RootPath)
                                    <span class="float-right">
                                        @(drive.UsagePercentage.ToString("F1"))%
                                    </span>
                                </h4>
                                <div class="progress mb-2">
                                    @{
                                        string progressClass = "bg-success";
                                        if (drive.UsagePercentage >= 95)
                                        {
                                            progressClass = "bg-danger";
                                        }
                                        else if (drive.UsagePercentage >= 85)
                                        {
                                            progressClass = "bg-warning";
                                        }
                                        else if (drive.UsagePercentage >= 70)
                                        {
                                            progressClass = "bg-info";
                                        }
                                    }
                                    <div class="progress-bar @progressClass" role="progressbar" style="width: @(drive.UsagePercentage)%"
                                         aria-valuenow="@(drive.UsagePercentage)" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="small">
                                    <span class="mr-2">
                                        <i class="fas fa-circle text-primary"></i> Used: @FormatBytes(drive.UsedSpace)
                                    </span>
                                    <span class="mr-2">
                                        <i class="fas fa-circle text-success"></i> Free: @FormatBytes(drive.FreeSpace)
                                    </span>
                                    <span class="mr-2">
                                        <i class="fas fa-circle text-info"></i> Total: @FormatBytes(drive.TotalSpace)
                                    </span>
                                    <span class="float-right text-xs">
                                        Last checked: @drive.LastCheckedAt.ToString("yyyy-MM-dd HH:mm:ss")
                                    </span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center">
                            <p>No storage drives configured.</p>
                            <a href="/Store/Create" class="btn btn-primary">Add Storage Drive</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Active Downloads -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Active Downloads</h6>
                </div>
                <div class="card-body">
                    <div id="activeDownloads">
                        <p class="text-center">Loading active downloads...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row">
        <!-- Downloads Per Day Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Downloads Per Day (Last 7 Days)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:300px;">
                        <canvas id="downloadsPerDayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Downloads Per Camera Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Downloads Per Camera</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:300px;">
                        <canvas id="downloadsPerCameraChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Check camera connection
            $('.check-camera').click(function() {
                const cameraId = $(this).data('id');
                const button = $(this);
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i>');
                
                $.ajax({
                    url: `/api/cameras/${cameraId}/check`,
                    type: 'POST',
                    success: function(result) {
                        if (result.isOnline) {
                            toastr.success('Camera is online!');
                            // Reload page after a short delay
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            toastr.error('Camera is offline.');
                            button.prop('disabled', false);
                            button.html('<i class="fas fa-sync"></i>');
                        }
                    },
                    error: function() {
                        toastr.error('Failed to check camera connection.');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync"></i>');
                    }
                });
            });
            
            // Check all cameras
            $('#checkAllCameras').click(function() {
                const button = $(this);
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i> Checking...');
                
                $.ajax({
                    url: '/api/cameras/check-all',
                    type: 'POST',
                    success: function() {
                        toastr.success('Camera health check triggered.');
                        // Reload page after a short delay
                        setTimeout(function() {
                            location.reload();
                        }, 3000);
                    },
                    error: function() {
                        toastr.error('Failed to trigger camera health check.');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync"></i> Check All');
                    }
                });
            });
            
            // Check storage
            $('#checkStorage').click(function() {
                const button = $(this);
                
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i> Checking...');
                
                $.ajax({
                    url: '/api/storage-drives/check',
                    type: 'POST',
                    success: function() {
                        toastr.success('Storage check triggered.');
                        // Reload page after a short delay
                        setTimeout(function() {
                            location.reload();
                        }, 3000);
                    },
                    error: function() {
                        toastr.error('Failed to trigger storage check.');
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync"></i> Check Storage');
                    }
                });
            });
            
            // Load active downloads
            function loadActiveDownloads() {
                $.ajax({
                    url: '/api/download-jobs/active',
                    type: 'GET',
                    success: function(jobs) {
                        if (jobs.length === 0) {
                            $('#activeDownloads').html('<p class="text-center">No active downloads.</p>');
                            return;
                        }
                        
                        let html = '<div class="table-responsive">';
                        html += '<table class="table table-bordered" width="100%" cellspacing="0">';
                        html += '<thead><tr><th>Camera</th><th>File</th><th>Progress</th><th>Started</th><th>Action</th></tr></thead>';
                        html += '<tbody>';
                        
                        jobs.forEach(function(job) {
                            html += '<tr>';
                            html += `<td>${job.camera.name}</td>`;
                            html += `<td>${job.fileName}</td>`;
                            html += '<td>';
                            html += `<div class="progress">`;
                            html += `<div class="progress-bar" role="progressbar" style="width: ${job.progress}%" `;
                            html += `aria-valuenow="${job.progress}" aria-valuemin="0" aria-valuemax="100">${job.progress}%</div>`;
                            html += '</div>';
                            html += '</td>';
                            html += `<td>${new Date(job.startTime).toLocaleString()}</td>`;
                            html += `<td><button class="btn btn-sm btn-danger cancel-job" data-id="${job.id}">Cancel</button></td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></div>';
                        $('#activeDownloads').html(html);
                        
                        // Attach event handlers to cancel buttons
                        $('.cancel-job').click(function() {
                            const jobId = $(this).data('id');
                            cancelJob(jobId);
                        });
                    },
                    error: function() {
                        $('#activeDownloads').html('<p class="text-center text-danger">Failed to load active downloads.</p>');
                    }
                });
            }
            
            function cancelJob(jobId) {
                $.ajax({
                    url: `/api/download-jobs/${jobId}/cancel`,
                    type: 'POST',
                    success: function() {
                        toastr.success('Download job cancelled.');
                        loadActiveDownloads();
                    },
                    error: function() {
                        toastr.error('Failed to cancel download job.');
                    }
                });
            }
            
            // Initial load
            loadActiveDownloads();
            
            // Refresh active downloads every 5 seconds
            setInterval(loadActiveDownloads, 5000);
            
            // Initialize charts
            initializeCharts();
        });
        
        function initializeCharts() {
            // Downloads Per Day Chart
            const downloadsPerDayCtx = document.getElementById('downloadsPerDayChart').getContext('2d');
            
            // Parse data from model
            const downloadsPerDayData = @Html.Raw(Json.Serialize(Model.DownloadsPerDay));
            
            // Sort data by date
            downloadsPerDayData.sort((a, b) => new Date(a.label) - new Date(b.label));
            
            // Format dates for display
            const labels = downloadsPerDayData.map(item => {
                const date = new Date(item.label);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const values = downloadsPerDayData.map(item => item.value);
            
            new Chart(downloadsPerDayCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Downloads',
                        data: values,
                        backgroundColor: 'rgba(78, 115, 223, 0.8)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Downloads Per Camera Chart
            const downloadsPerCameraCtx = document.getElementById('downloadsPerCameraChart').getContext('2d');
            
            // Parse data from model
            const downloadsPerCameraData = @Html.Raw(Json.Serialize(Model.DownloadsPerCamera));
            
            // Convert dictionary to arrays
            const cameraLabels = Object.keys(downloadsPerCameraData);
            const cameraValues = Object.values(downloadsPerCameraData);
            
            // Generate colors
            const backgroundColors = cameraLabels.map((_, i) => {
                const hue = (i * 137) % 360; // Use golden angle approximation for color distribution
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            
            new Chart(downloadsPerCameraCtx, {
                type: 'doughnut',
                data: {
                    labels: cameraLabels,
                    datasets: [{
                        data: cameraValues,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12
                            }
                        }
                    }
                }
            });
        }
    </script>
}

@functions {
    public string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size = size / 1024;
        }
        
        return $"{size:0.##} {sizes[order]}";
    }
}
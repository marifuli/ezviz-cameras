@model HikvisionService.Controllers.HomeController.DashboardViewModel
@{
    ViewData["Title"] = "Live Camera Feeds";
    Layout = "_Layout";
}

<div class="p-4">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">Live Camera Feeds</h1>

    @foreach(var recording in Model.Recordings)
    {
        <h6>@recording.Name</h6>
        <h6>@recording.Duration</h6>
        <h6>@recording.Size</h6>
    }

    @if (Model.Cameras.Any())
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
            @foreach(var camera in Model.Cameras)
            {
                <div class="relative bg-gray-100 rounded-lg overflow-hidden shadow-lg">
                    <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm z-10">
                        @camera.Name
                    </div>
                    <video id="video-@camera.Id" class="w-full h-48 object-cover" controls autoplay muted></video>
                </div>
            }
        </div>
    }
    else
    {
        <p class="text-gray-600">No cameras found for the selected stores.</p>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        $(document).ready(function() {
            $('#stores').select2({
                placeholder: 'Select stores',
                allowClear: true
            });
        });
    </script>
    <script>
        let host = "localhost", // You can make this configurable
            username = "admin", // You can make this configurable
            password = "admin", // You can make this configurable 
            local = window.location.origin.includes('localhost') ? 'http' : 'https',
            cameras = @Html.Raw(Json.Serialize(Model.Cameras.Select(c => new { Id = c.Id, Name = c.Name })));

        cameras.forEach(camera => {
            const video = document.getElementById('video-' + camera.id);
            const videoSrc = local + `://${host}:8888/cam${camera.id}/index.m3u8`;

            if (Hls.isSupported()) {
                const hls = new Hls({
                    xhrSetup: function (xhr, url) {
                        const credentials = btoa(`${username}:${password}`);
                        xhr.setRequestHeader("Authorization", `Basic ${credentials}`);
                    },
                });
                hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                    hls.loadSource(videoSrc);
                });
                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc;
            }
        });
    </script>
}
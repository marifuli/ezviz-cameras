@model HikvisionService.Models.ViewModels.FootageViewModel
@{
    ViewData["Title"] = "Footage Archive";
}

<div class="px-6 py-4">
    <h1 class="text-3xl font-bold mb-2">Footage Archive</h1>
    <p class="text-gray-600 mb-6">Browse and download saved camera footage</p>

    <!-- Filter Form (unchanged) -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-blue-600">Filter Options</h2>
        </div>
        <div class="px-6 py-4">
            <form asp-action="Index" method="get" id="filterForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="SelectedCameraId" class="block text-sm font-medium text-gray-700 mb-1">Camera</label>
                        <select asp-for="SelectedCameraId" class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Cameras</option>
                            @foreach (var camera in Model.Cameras)
                            {
                                <option value="@camera.Id">@camera.Name</option>
                            }
                        </select>
                    </div>
                    <div>
                        <label for="StartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" asp-for="StartDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <label for="EndDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" asp-for="EndDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <label for="FileType" class="block text-sm font-medium text-gray-700 mb-1">File Type</label>
                        <select asp-for="FileType" class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="both">All Files</option>
                            <option value="video">Videos Only</option>
                            <option value="photo">Photos Only</option>
                        </select>
                    </div>
                </div>

                <div class="flex space-x-2 mt-4">
                    <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i> Apply Filters
                    </button>
                    <a href="@Url.Action("Index")" class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-400">
                        <i class="fas fa-sync mr-2"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>


    <!-- Download Section -->
    <div class="bg-white shadow rounded-lg p-6">
        @if (Model.Files.Any())
        {
            <p class="text-gray-700 mb-4 font-semibold">Found <span id="fileCount">@Model.Files.Count</span> files</p>
            <div class="flex space-x-2 mb-4">
                <button id="startDownload" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex-1 flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i> Start Download
                </button>
                <button id="cancelDownload" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 flex-1 flex items-center justify-center hidden">
                    <i class="fas fa-times mr-2"></i> Cancel
                </button>
            </div>

            <!-- Global Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                <div id="globalProgress" class="bg-blue-600 h-6 w-0 transition-all"></div>
            </div>
            <p id="progressText" class="text-center text-gray-700 mt-2">0 / @Model.Files.Count</p>
        }
        else
        {
            <div class="text-center py-20 text-gray-400">
                <i class="fas fa-search fa-3x mb-4"></i>
                <p class="text-lg font-semibold mb-2">No footage files found matching your criteria.</p>
                <p>Try adjusting your filters or selecting a different date range.</p>
            </div>
        }
    </div>


</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', () => {
    const files = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Files.Select(f => new { f.FilePath, f.FileName })));
    const startBtn = document.getElementById('startDownload');
    const cancelBtn = document.getElementById('cancelDownload');
    const progressBar = document.getElementById('globalProgress');
    const progressText = document.getElementById('progressText');

    let abortControllers = [];
    let stopped = false;

    async function downloadFile(file, dirHandle) {
        const fileHandle = await dirHandle.getFileHandle(file.FileName, { create: true });
        const writable = await fileHandle.createWritable();

        const controller = new AbortController();
        abortControllers.push(controller);

        const response = await fetch(`/Footage/Download?path=${encodeURIComponent(file.FilePath)}`, { signal: controller.signal });
        const reader = response.body.getReader();
        const contentLength = +response.headers.get('Content-Length') || 0;
        let received = 0;

        while (true) {
            const { done, value } = await reader.read();
            if (done || stopped) break;
            await writable.write(value);
            received += value.byteLength; // <-- use byteLength, not length

            // Update global progress percentage
            let fileProgress = contentLength ? received / contentLength : 0;
            let totalProgress = ((downloadProgress.completedFiles + fileProgress) / downloadProgress.totalFiles) * 100;

            progressBar.style.width = `${Math.min(totalProgress, 100).toFixed(2)}%`;
        }

        await writable.close();
        if (!stopped) downloadProgress.completedFiles++;
        updateProgressText();
    }

    const downloadProgress = { completedFiles: 0, totalFiles: files.length };

    function updateProgressText() {
        progressText.innerText = `${downloadProgress.completedFiles} / ${downloadProgress.totalFiles}`;
    }

    async function startDownloads() {
        if (!files.length) return;

        stopped = false;
        abortControllers = [];
        downloadProgress.completedFiles = 0;
        updateProgressText();

        startBtn.classList.add('hidden');
        cancelBtn.classList.remove('hidden');
        progressBar.style.width = '0%';

        const dirHandle = await window.showDirectoryPicker();
        const concurrency = 5;
        let index = 0;

        async function worker() {
            while (index < files.length && !stopped) {
                const currentIndex = index++;
                const currentFile = files[currentIndex];
                try {
                    await downloadFile(currentFile, dirHandle);
                } catch (err) {
                    if (!stopped) console.error(`Failed: ${currentFile.FileName}`, err);
                }
            }
        }

        // Run workers in parallel
        await Promise.all(Array.from({ length: concurrency }, () => worker()));

        startBtn.classList.remove('hidden');
        cancelBtn.classList.add('hidden');

        if (!stopped) {
            progressBar.style.width = '100%';
            toastr.success('All downloads completed successfully!');
        }
    }

    function cancelDownloads() {
        stopped = true;
        abortControllers.forEach(ctrl => ctrl.abort());
        startBtn.classList.remove('hidden');
        cancelBtn.classList.add('hidden');
        toastr.warning('Downloads cancelled.');
    }

    startBtn.addEventListener('click', startDownloads);
    cancelBtn.addEventListener('click', cancelDownloads);
});
</script>
}

@functions {
    public string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size = size / 1024;
        }
        
        return $"{size:0.##} {sizes[order]}";
    }
}